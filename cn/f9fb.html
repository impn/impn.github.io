<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="theme-color" content="#f8f5ec"><meta name="msapplication-navbutton-color" content="#f8f5ec"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec"><meta name="referrer" content="same-origin"><meta name="referrer" content="no-referrer"><meta name="description" content="10道经典Hive题目"><meta name="keywords" content="大数据,BigData,数据开发,Hadoop,Spark,Flink,Hive,HBase"><link rel="alternate" href="/cn/atom.xml" title="马攀的技术栈"><link rel="shortcut icon" type="image/x-icon" href="/cn/favicon.ico?v=2.11.0"><link rel="canonical" href="https://mapan.tech/cn/f9fb.html"><link rel="stylesheet" type="text/css" href="/cn/css/style.css?v=2.11.0"><script>window.config={toc:!0,fancybox:!1,pjax:!1,latex:!1}</script><title>10道经典Hive题目 - 马攀的技术栈</title></head><body><div id="mobile-navbar" class="mobile-navbar"><div class="mobile-header-logo"><a href="/cn/." class="logo">马攀的技术栈</a></div><div class="mobile-navbar-icon"><span></span> <span></span> <span></span></div></div><nav id="mobile-menu" class="mobile-menu slideout-menu"><ul class="mobile-menu-list"><a href="/cn/"><li class="mobile-menu-item">首页</li></a><a href="/cn/categories.html"><li class="mobile-menu-item">分类</li></a><a href="/cn/about.html"><li class="mobile-menu-item">关于</li></a><a href="/cn/message.html"><li class="mobile-menu-item">留言</li></a><a href="/cn/links.html"><li class="mobile-menu-item">友链</li></a></ul></nav><div class="container" id="mobile-panel"><header id="header" class="header"><div class="logo-wrapper"><a href="https://mapan.tech" class="logo">马攀的技术栈</a></div><nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item"><a class="menu-item-link" href="/cn/">首页</a></li><li class="menu-item"><a class="menu-item-link" href="/cn/categories.html">分类</a></li><li class="menu-item"><a class="menu-item-link" href="/cn/about.html">关于</a></li><li class="menu-item"><a class="menu-item-link" href="/cn/message.html">留言</a></li><li class="menu-item"><a class="menu-item-link" href="/cn/links.html">友链</a></li></ul></nav></header><main id="main" class="main"><div class="content-wrapper"><div id="content" class="content"><article class="post"><header class="post-header"><h1 class="post-title">10道经典Hive题目</h1><div class="post-meta"><span class="post-time">2020-05-14 </span><span class="post-category"><a href="/cn/categories/Hive/">Hive</a> </span><span id="/cn/f9fb.html" class="leancloud-visitors" data-flag-title="10道经典Hive题目">阅读数 <span class="leancloud-visitors-count">1000</span> </span><span class="post-count">字数统计 4.5k </span><span class="post-count">阅读时长 22</span></div></header><div class="post-toc" id="post-toc"><h2 class="post-toc-title">文章目录</h2><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#第一题"><span class="toc-text">第一题</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#第二题"><span class="toc-text">第二题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第三题"><span class="toc-text">第三题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第四题"><span class="toc-text">第四题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第五题"><span class="toc-text">第五题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第六题"><span class="toc-text">第六题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第七题"><span class="toc-text">第七题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第八题"><span class="toc-text">第八题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第九题"><span class="toc-text">第九题</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#第十题："><span class="toc-text">第十题：</span></a></li></ol></li></ol></div></div><div class="post-content"><p>我有早起的习惯，每天早晨上班前的这段时间脑子非常清醒，这段时间我会用来充实自己。看到某个公众号发了一篇Hive的面试题的推文，顺手拿过来做了下。共计10道题，花了下班后的晚上和一个早晨的时间写完。</p><h1 id="第一题"><a href="#第一题" class="headerlink" title="第一题"></a>第一题</h1><p>需求：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">我们有如下的用户访问数据</span><br><span class="line">    userId  visitDate   visitCount</span><br><span class="line">    u01 2017/1/21   5</span><br><span class="line">    u02 2017/1/23   6</span><br><span class="line">    u03 2017/1/22   8</span><br><span class="line">    u04 2017/1/20   3</span><br><span class="line">    u01 2017/1/23   6</span><br><span class="line">    u01 2017/2/21   8</span><br><span class="line">    U02 2017/1/23   6</span><br><span class="line">    U01 2017/2/22   4</span><br><span class="line">要求使用SQL统计出每个用户的累积访问次数，如下表所示：</span><br><span class="line">    用户id    月份  小计  累积</span><br><span class="line">    u01 2017-01 11  11</span><br><span class="line">    u01 2017-02 12  23</span><br><span class="line">    u02 2017-01 12  12</span><br><span class="line">    u03 2017-01 8   8</span><br><span class="line">    u04 2017-01 3   3</span><br></pre></td></tr></table></figure><p></p><p>实现：<br>数据准备：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test1 ( </span><br><span class="line">        userId <span class="keyword">string</span>, </span><br><span class="line">        visitDate <span class="keyword">string</span>,</span><br><span class="line">        visitCount <span class="built_in">INT</span> )</span><br><span class="line">    <span class="keyword">ROW</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">"\t"</span>;</span><br><span class="line">    <span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test1</span><br><span class="line">    <span class="keyword">VALUES</span></span><br><span class="line">        ( <span class="string">'u01'</span>, <span class="string">'2017/1/21'</span>, <span class="number">5</span> ),</span><br><span class="line">        ( <span class="string">'u02'</span>, <span class="string">'2017/1/23'</span>, <span class="number">6</span> ),</span><br><span class="line">        ( <span class="string">'u03'</span>, <span class="string">'2017/1/22'</span>, <span class="number">8</span> ),</span><br><span class="line">        ( <span class="string">'u04'</span>, <span class="string">'2017/1/20'</span>, <span class="number">3</span> ),</span><br><span class="line">        ( <span class="string">'u01'</span>, <span class="string">'2017/1/23'</span>, <span class="number">6</span> ),</span><br><span class="line">        ( <span class="string">'u01'</span>, <span class="string">'2017/2/21'</span>, <span class="number">8</span> ),</span><br><span class="line">        ( <span class="string">'u02'</span>, <span class="string">'2017/1/23'</span>, <span class="number">6</span> ),</span><br><span class="line">        ( <span class="string">'u01'</span>, <span class="string">'2017/2/22'</span>, <span class="number">4</span> );</span><br></pre></td></tr></table></figure><p></p><p>查询SQL：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">with t1 as(</span><br><span class="line">    select</span><br><span class="line">        userid,</span><br><span class="line">        date_format(regexp_replace(visitdate,&apos;/&apos;,&apos;-&apos;),&apos;YYYY-MM&apos;) as vdate,</span><br><span class="line">        sum(visitcount) as vcount</span><br><span class="line">    from prac.test1</span><br><span class="line">    group by userid,date_format(regexp_replace(visitdate,&apos;/&apos;,&apos;-&apos;),&apos;YYYY-MM&apos;)</span><br><span class="line">)</span><br><span class="line">select</span><br><span class="line">    userid,</span><br><span class="line">    vdate,</span><br><span class="line">    vcount,</span><br><span class="line">    sum(vcount) over (partition by userid order by vdate)</span><br><span class="line">from t1;</span><br></pre></td></tr></table></figure><p></p><h2 id="第二题"><a href="#第二题" class="headerlink" title="第二题"></a>第二题</h2><p>需求：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">有50W个京东店铺，每个顾客访客访问任何一个店铺的任何一个商品时都会产生一条访问日志，</span><br><span class="line">访问日志存储的表名为Visit，访客的用户id为user_id，被访问的店铺名称为shop，数据如下：</span><br><span class="line"></span><br><span class="line">                u1  a</span><br><span class="line">                u2  b</span><br><span class="line">                u1  b</span><br><span class="line">                u1  a</span><br><span class="line">                u3  c</span><br><span class="line">                u4  b</span><br><span class="line">                u1  a</span><br><span class="line">                u2  c</span><br><span class="line">                u5  b</span><br><span class="line">                u4  b</span><br><span class="line">                u6  c</span><br><span class="line">                u2  c</span><br><span class="line">                u1  b</span><br><span class="line">                u2  a</span><br><span class="line">                u2  a</span><br><span class="line">                u3  a</span><br><span class="line">                u5  a</span><br><span class="line">                u5  a</span><br><span class="line">                u5  a</span><br><span class="line">请统计：</span><br><span class="line">(1)每个店铺的UV（访客数）</span><br><span class="line">(2)每个店铺访问次数top3的访客信息。输出店铺名称、访客id、访问次数</span><br></pre></td></tr></table></figure><p></p><p>数据准备：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test2 ( </span><br><span class="line">    user_id <span class="keyword">string</span>, </span><br><span class="line">    shop <span class="keyword">string</span> </span><br><span class="line">)</span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">FIELDS</span> <span class="keyword">TERMINATED</span> <span class="keyword">BY</span> <span class="string">'\t'</span>; </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test2 <span class="keyword">VALUES</span></span><br><span class="line">( <span class="string">'u1'</span>, <span class="string">'a'</span> ),</span><br><span class="line">( <span class="string">'u2'</span>, <span class="string">'b'</span> ),</span><br><span class="line">( <span class="string">'u1'</span>, <span class="string">'b'</span> ),</span><br><span class="line">( <span class="string">'u1'</span>, <span class="string">'a'</span> ),</span><br><span class="line">( <span class="string">'u3'</span>, <span class="string">'c'</span> ),</span><br><span class="line">( <span class="string">'u4'</span>, <span class="string">'b'</span> ),</span><br><span class="line">( <span class="string">'u1'</span>, <span class="string">'a'</span> ),</span><br><span class="line">( <span class="string">'u2'</span>, <span class="string">'c'</span> ),</span><br><span class="line">( <span class="string">'u5'</span>, <span class="string">'b'</span> ),</span><br><span class="line">( <span class="string">'u4'</span>, <span class="string">'b'</span> ),</span><br><span class="line">( <span class="string">'u6'</span>, <span class="string">'c'</span> ),</span><br><span class="line">( <span class="string">'u2'</span>, <span class="string">'c'</span> ),</span><br><span class="line">( <span class="string">'u1'</span>, <span class="string">'b'</span> ),</span><br><span class="line">( <span class="string">'u2'</span>, <span class="string">'a'</span> ),</span><br><span class="line">( <span class="string">'u2'</span>, <span class="string">'a'</span> ),</span><br><span class="line">( <span class="string">'u3'</span>, <span class="string">'a'</span> ),</span><br><span class="line">( <span class="string">'u5'</span>, <span class="string">'a'</span> ),</span><br><span class="line">( <span class="string">'u5'</span>, <span class="string">'a'</span> ),</span><br><span class="line">( <span class="string">'u5'</span>, <span class="string">'a'</span> );</span><br></pre></td></tr></table></figure><p></p><p>查询SQL：<br>(1)每个店铺的UV（访客数）<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    shop,</span><br><span class="line">    <span class="keyword">count</span>(<span class="keyword">distinct</span> user_id) <span class="keyword">as</span> user_cnt</span><br><span class="line"><span class="keyword">from</span> prac.test2</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> shop;</span><br></pre></td></tr></table></figure><p></p><p>(2)每个店铺访问次数top3的访客信息。输出店铺名称、访客id、访问次数<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        shop,</span><br><span class="line">        user_id,</span><br><span class="line">        <span class="keyword">count</span>(user_id) <span class="keyword">as</span> cnt</span><br><span class="line">    <span class="keyword">from</span> prac.test2</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> shop,user_id</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> (</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        shop,</span><br><span class="line">        user_id,</span><br><span class="line">        cnt,</span><br><span class="line">        <span class="keyword">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> shop <span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span> t1</span><br><span class="line">) <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">where</span> rk&lt;=<span class="number">3</span>;</span><br></pre></td></tr></table></figure><p></p><h2 id="第三题"><a href="#第三题" class="headerlink" title="第三题"></a>第三题</h2><p>需求<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">已知一个表STG.ORDER，有如下字段:Date，Order_id，User_id，amount。</span><br><span class="line">数据样例:2017-01-01,10029028,1000003251,33.57。</span><br><span class="line">请给出sql进行统计:</span><br><span class="line">(1)给出 2017年每个月的订单数、用户数、总成交金额。</span><br><span class="line">(2)给出2017年11月的新客数(指在11月才有第一笔订单)</span><br></pre></td></tr></table></figure><p></p><p>数据准备:<br></p><figure class="highlight plain"><figcaption><span>TABLE prac.test3 (</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">            dt string,</span><br><span class="line">            order_id string, </span><br><span class="line">            user_id string, </span><br><span class="line">            amount DECIMAL ( 10, 2 ) )</span><br><span class="line">ROW format delimited FIELDS TERMINATED BY &apos;\t&apos;;</span><br><span class="line">INSERT INTO TABLE prac.test3 VALUES (&apos;2017-01-01&apos;,&apos;10029028&apos;,&apos;1000003251&apos;,33.57);</span><br><span class="line">INSERT INTO TABLE prac.test3 VALUES (&apos;2017-01-01&apos;,&apos;10029029&apos;,&apos;1000003251&apos;,33.57);</span><br><span class="line">INSERT INTO TABLE prac.test3 VALUES (&apos;2017-01-01&apos;,&apos;100290288&apos;,&apos;1000003252&apos;,33.57);</span><br><span class="line">INSERT INTO TABLE prac.test3 VALUES (&apos;2017-02-02&apos;,&apos;10029088&apos;,&apos;1000003251&apos;,33.57);</span><br><span class="line">INSERT INTO TABLE prac.test3 VALUES (&apos;2017-02-02&apos;,&apos;100290281&apos;,&apos;1000003251&apos;,33.57);</span><br><span class="line">INSERT INTO TABLE prac.test3 VALUES (&apos;2017-02-02&apos;,&apos;100290282&apos;,&apos;1000003253&apos;,33.57);</span><br><span class="line">INSERT INTO TABLE prac.test3 VALUES (&apos;2017-11-02&apos;,&apos;10290282&apos;,&apos;100003253&apos;,234);</span><br><span class="line">INSERT INTO TABLE prac.test3 VALUES (&apos;2018-11-02&apos;,&apos;10290284&apos;,&apos;100003243&apos;,234);</span><br></pre></td></tr></table></figure><p></p><p>查询SQL：<br>(1)给出 2017年每个月的订单数、用户数、总成交金额。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">date_format</span>(dt,<span class="string">'YYYY-MM'</span>) <span class="keyword">as</span> mon,</span><br><span class="line">    <span class="keyword">count</span>(order_id) <span class="keyword">as</span> order_cnt,</span><br><span class="line">    <span class="keyword">count</span>(user_id) <span class="keyword">as</span> user_cnt,</span><br><span class="line">    <span class="keyword">sum</span>(amount) <span class="keyword">as</span> AMT</span><br><span class="line"><span class="keyword">from</span> prac.test3</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">date_format</span>(dt,<span class="string">'YYYY-MM'</span>);</span><br></pre></td></tr></table></figure><p>(2)给出2017年11月的新客数(指在11月才有第一笔订单)<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">with t1 as(</span><br><span class="line">    select</span><br><span class="line">        user_id</span><br><span class="line">    from prac.test3</span><br><span class="line">    where dt&lt;to_date(&apos;2017-11-01&apos;)</span><br><span class="line">)</span><br><span class="line">select</span><br><span class="line">    date_format(dt,&apos;YYYY-MM&apos;),</span><br><span class="line">    count(1)</span><br><span class="line">from prac.test3</span><br><span class="line">where dt between &apos;2017-11-01&apos; and &apos;2017-11-30&apos;</span><br><span class="line"> and user_id not in (select t1.user_id from t1)</span><br><span class="line">group by date_format(dt,&apos;YYYY-MM&apos;)</span><br></pre></td></tr></table></figure><p></p><p>不得不说答案上的这个写法真的很巧妙:<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> <span class="keyword">count</span>(user_id)</span><br><span class="line"><span class="keyword">FROM</span> prac.test3</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> user_id</span><br><span class="line"><span class="keyword">HAVING</span> <span class="keyword">date_format</span>(<span class="keyword">min</span>(dt),<span class="string">'yyyy-MM'</span>)=<span class="string">'2017-11'</span>;</span><br></pre></td></tr></table></figure><p></p><h2 id="第四题"><a href="#第四题" class="headerlink" title="第四题"></a>第四题</h2><p>需求：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">有一个5000万的用户文件(user_id，name，age)，一个2亿记录的用户看电影的记录文件(user_id，url)，根据年龄段观看电影的次数进行排序？</span><br></pre></td></tr></table></figure><p></p><p>数据准备：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test4user</span><br><span class="line">           (user_id <span class="keyword">string</span>,</span><br><span class="line">            <span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">            age <span class="built_in">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test4log</span><br><span class="line">                        (user_id <span class="keyword">string</span>,</span><br><span class="line">                        <span class="keyword">url</span> <span class="keyword">string</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test4user <span class="keyword">VALUES</span></span><br><span class="line"> (<span class="string">'001'</span>,<span class="string">'u1'</span>,<span class="number">10</span>)</span><br><span class="line">,(<span class="string">'002'</span>,<span class="string">'u2'</span>,<span class="number">15</span>)</span><br><span class="line">,(<span class="string">'003'</span>,<span class="string">'u3'</span>,<span class="number">15</span>)  </span><br><span class="line">,(<span class="string">'004'</span>,<span class="string">'u4'</span>,<span class="number">20</span>) </span><br><span class="line">,(<span class="string">'005'</span>,<span class="string">'u5'</span>,<span class="number">25</span>)</span><br><span class="line">,(<span class="string">'006'</span>,<span class="string">'u6'</span>,<span class="number">35</span>) </span><br><span class="line">,(<span class="string">'007'</span>,<span class="string">'u7'</span>,<span class="number">40</span>)</span><br><span class="line">,(<span class="string">'008'</span>,<span class="string">'u8'</span>,<span class="number">45</span>)</span><br><span class="line">,(<span class="string">'009'</span>,<span class="string">'u9'</span>,<span class="number">50</span>)</span><br><span class="line">,(<span class="string">'0010'</span>,<span class="string">'u10'</span>,<span class="number">65</span>);  </span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test4log <span class="keyword">VALUES</span></span><br><span class="line"> (<span class="string">'001'</span>,<span class="string">'url1'</span>)</span><br><span class="line">,(<span class="string">'002'</span>,<span class="string">'url1'</span>)  </span><br><span class="line">,(<span class="string">'003'</span>,<span class="string">'url2'</span>)  </span><br><span class="line">,(<span class="string">'004'</span>,<span class="string">'url3'</span>)  </span><br><span class="line">,(<span class="string">'005'</span>,<span class="string">'url3'</span>)  </span><br><span class="line">,(<span class="string">'006'</span>,<span class="string">'url1'</span>)  </span><br><span class="line">,(<span class="string">'007'</span>,<span class="string">'url5'</span>)</span><br><span class="line">,(<span class="string">'008'</span>,<span class="string">'url7'</span>) </span><br><span class="line">,(<span class="string">'009'</span>,<span class="string">'url5'</span>) </span><br><span class="line">,(<span class="string">'0010'</span>,<span class="string">'url1'</span>);</span><br></pre></td></tr></table></figure><p></p><p>查询SQL：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        user_id,</span><br><span class="line">        <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> move_cnt</span><br><span class="line">    <span class="keyword">from</span> prac.test4log</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> user_id</span><br><span class="line">),t2 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        user_id,</span><br><span class="line">        <span class="keyword">name</span>,</span><br><span class="line">        (<span class="keyword">case</span> <span class="keyword">when</span> age&gt;=<span class="number">0</span>  <span class="keyword">and</span> age&lt;<span class="number">10</span> <span class="keyword">then</span> <span class="string">'0-9'</span></span><br><span class="line">              <span class="keyword">when</span> age&gt;=<span class="number">10</span> <span class="keyword">and</span> age&lt;<span class="number">20</span> <span class="keyword">then</span> <span class="string">'10-19'</span></span><br><span class="line">              <span class="keyword">when</span> age&gt;=<span class="number">20</span> <span class="keyword">and</span> age&lt;<span class="number">30</span> <span class="keyword">then</span> <span class="string">'20-29'</span></span><br><span class="line">              <span class="keyword">when</span> age&gt;=<span class="number">30</span> <span class="keyword">and</span> age&lt;<span class="number">40</span> <span class="keyword">then</span> <span class="string">'30-39'</span></span><br><span class="line">              <span class="keyword">when</span> age&gt;=<span class="number">40</span> <span class="keyword">and</span> age&lt;<span class="number">50</span> <span class="keyword">then</span> <span class="string">'40-49'</span></span><br><span class="line">              <span class="keyword">when</span> age&gt;=<span class="number">50</span> <span class="keyword">and</span> age&lt;<span class="number">60</span> <span class="keyword">then</span> <span class="string">'50-59'</span></span><br><span class="line">              <span class="keyword">when</span> age&gt;=<span class="number">60</span> <span class="keyword">and</span> age&lt;<span class="number">70</span> <span class="keyword">then</span> <span class="string">'60-69'</span></span><br><span class="line">              <span class="keyword">when</span> age&gt;=<span class="number">70</span> <span class="keyword">and</span> age&lt;<span class="number">80</span> <span class="keyword">then</span> <span class="string">'70-79'</span></span><br><span class="line">       <span class="keyword">else</span> <span class="string">'80及以上'</span> <span class="keyword">end</span>) <span class="keyword">as</span> age_peroid</span><br><span class="line">    <span class="keyword">from</span> prac.test4user</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    t2.age_peroid,</span><br><span class="line">    <span class="keyword">sum</span>(t1.move_cnt)</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">join</span> t2</span><br><span class="line">  <span class="keyword">on</span> t1.user_id=t2.user_id</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> age_peroid;</span><br></pre></td></tr></table></figure><p></p><h2 id="第五题"><a href="#第五题" class="headerlink" title="第五题"></a>第五题</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">有日志如下，请写出代码求得所有用户和活跃用户的总数及平均年龄。（活跃用户指连续两天都有访问记录的用户）</span><br><span class="line">日期 用户 年龄</span><br><span class="line">2019-02-11,test_1,23</span><br><span class="line">2019-02-11,test_2,19</span><br><span class="line">2019-02-11,test_3,39</span><br><span class="line">2019-02-11,test_1,23</span><br><span class="line">2019-02-11,test_3,39</span><br><span class="line">2019-02-11,test_1,23</span><br><span class="line">2019-02-12,test_2,19</span><br><span class="line">2019-02-13,test_1,23</span><br><span class="line">2019-02-15,test_2,19</span><br><span class="line">2019-02-16,test_2,19</span><br></pre></td></tr></table></figure><p>数据准备：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test5(</span><br><span class="line">dt <span class="keyword">string</span>,</span><br><span class="line">user_id <span class="keyword">string</span>,</span><br><span class="line">age <span class="built_in">int</span>)</span><br><span class="line"><span class="keyword">ROW</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">BY</span> <span class="string">','</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test5 <span class="keyword">VALUES</span> </span><br><span class="line"> (<span class="string">'2019-02-11'</span>,<span class="string">'test_1'</span>,<span class="number">23</span>)</span><br><span class="line">,(<span class="string">'2019-02-11'</span>,<span class="string">'test_2'</span>,<span class="number">19</span>)</span><br><span class="line">,(<span class="string">'2019-02-11'</span>,<span class="string">'test_3'</span>,<span class="number">39</span>)</span><br><span class="line">,(<span class="string">'2019-02-11'</span>,<span class="string">'test_1'</span>,<span class="number">23</span>)</span><br><span class="line">,(<span class="string">'2019-02-11'</span>,<span class="string">'test_3'</span>,<span class="number">39</span>)</span><br><span class="line">,(<span class="string">'2019-02-11'</span>,<span class="string">'test_1'</span>,<span class="number">23</span>)</span><br><span class="line">,(<span class="string">'2019-02-12'</span>,<span class="string">'test_2'</span>,<span class="number">19</span>)</span><br><span class="line">,(<span class="string">'2019-02-13'</span>,<span class="string">'test_1'</span>,<span class="number">23</span>)</span><br><span class="line">,(<span class="string">'2019-02-15'</span>,<span class="string">'test_2'</span>,<span class="number">19</span>)                                  </span><br><span class="line">,(<span class="string">'2019-02-16'</span>,<span class="string">'test_2'</span>,<span class="number">19</span>);</span><br></pre></td></tr></table></figure><p></p><p>查询SQL：<br>求得所有用户和活跃用户的总数及平均年龄。（活跃用户指连续两天都有访问记录的用户）</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt_all,</span><br><span class="line">        <span class="keyword">avg</span>(age) <span class="keyword">as</span> avg_all</span><br><span class="line">    <span class="keyword">from</span>( </span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            user_id,</span><br><span class="line">            age</span><br><span class="line">        <span class="keyword">from</span> prac.test5</span><br><span class="line">        <span class="keyword">group</span> <span class="keyword">by</span> user_id,age</span><br><span class="line">    )</span><br><span class="line">),t2 <span class="keyword">as</span> (</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    t4.user_id,</span><br><span class="line">    t4.age</span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        t3.user_id,</span><br><span class="line">        t3.age</span><br><span class="line">    <span class="keyword">from</span>(</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            dt,</span><br><span class="line">            user_id,</span><br><span class="line">            age,</span><br><span class="line">            rk,</span><br><span class="line">            <span class="keyword">date_sub</span>(dt,rk) <span class="keyword">as</span> flag</span><br><span class="line">        <span class="keyword">from</span> (</span><br><span class="line">            <span class="keyword">select</span></span><br><span class="line">                t0.dt,</span><br><span class="line">                t0.user_id,</span><br><span class="line">                t0.age,</span><br><span class="line">                <span class="keyword">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> t1.user_id <span class="keyword">order</span> <span class="keyword">by</span> t1.dt) <span class="keyword">as</span> rk</span><br><span class="line">            <span class="keyword">from</span>(</span><br><span class="line">                <span class="keyword">select</span></span><br><span class="line">                    dt,</span><br><span class="line">                    user_id,</span><br><span class="line">                    age</span><br><span class="line">                <span class="keyword">from</span> prac.test5</span><br><span class="line">                <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">                    dt,</span><br><span class="line">                    user_id,</span><br><span class="line">                    age</span><br><span class="line">            ) <span class="keyword">as</span> t0 <span class="comment">-- 对用户访问表去重</span></span><br><span class="line">        )</span><br><span class="line">    ) <span class="keyword">as</span> t3</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        t3.user_id,</span><br><span class="line">        t3.age,</span><br><span class="line">        t3.flag</span><br><span class="line">    <span class="keyword">having</span> <span class="keyword">count</span>(<span class="number">1</span>)&gt;=<span class="number">2</span></span><br><span class="line">) <span class="keyword">as</span> t4</span><br><span class="line"><span class="keyword">group</span> <span class="keyword">by</span> </span><br><span class="line">    t4.user_id,</span><br><span class="line">    t4.age</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span> </span><br><span class="line">	<span class="keyword">count</span>(t2.user_id),</span><br><span class="line">	<span class="keyword">avg</span>(t2.age)</span><br><span class="line"><span class="keyword">from</span> t2</span><br><span class="line"><span class="keyword">union</span> <span class="keyword">all</span></span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">	cnt_all,</span><br><span class="line">	avg_all</span><br><span class="line"><span class="keyword">from</span> t1;</span><br></pre></td></tr></table></figure><p>这道题比较复杂，难度在于如何求活跃用户，首先对用户活跃日志进行去重，每个用户每天只保留一条，然后对其按照用户分组，按照日期升序，使用row_number对其打上序号rk。<br>不难看出，如果是连续登录，那么日期dt和序号会是一个等差数列，故用登陆日期dt和序号做差，得到新的日期起别名flag。然后按照user_id和flag进行分组，如果一个分组内的数据量大于等于2，就说明这位用户是活跃用户。得到活跃用户，再一次进行去重操作，因为同一用户可能多次活跃，被判定为多次活跃用户。得到活跃用户再求他们的数量和平均年龄就比较简单了。</p><h2 id="第六题"><a href="#第六题" class="headerlink" title="第六题"></a>第六题</h2><p>需求：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">请用sql写出所有用户中在今年10月份第一次购买商品的金额，</span><br><span class="line">表ordertable字段:</span><br><span class="line">(购买用户：userid，金额：money，购买时间：paymenttime(格式：2017-10-01)，订单id：orderid</span><br></pre></td></tr></table></figure><p></p><p>数据准备:<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test6 (</span><br><span class="line">        userid <span class="keyword">string</span>,</span><br><span class="line">        money <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>),</span><br><span class="line">        paymenttime <span class="keyword">string</span>,</span><br><span class="line">        orderid <span class="keyword">string</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test6 <span class="keyword">VALUES</span></span><br><span class="line"> (<span class="string">'001'</span>,<span class="number">100</span>,<span class="string">'2017-10-01'</span>,<span class="string">'123'</span>)</span><br><span class="line">,(<span class="string">'001'</span>,<span class="number">200</span>,<span class="string">'2017-10-02'</span>,<span class="string">'124'</span>)</span><br><span class="line">,(<span class="string">'002'</span>,<span class="number">500</span>,<span class="string">'2017-10-01'</span>,<span class="string">'125'</span>)</span><br><span class="line">,(<span class="string">'001'</span>,<span class="number">100</span>,<span class="string">'2017-11-01'</span>,<span class="string">'126'</span>);</span><br></pre></td></tr></table></figure><p></p><p>查询SQL：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    userid,</span><br><span class="line">    money,</span><br><span class="line">    <span class="keyword">rank</span>() <span class="keyword">over</span> (<span class="keyword">partition</span> <span class="keyword">by</span> userid <span class="keyword">order</span> <span class="keyword">by</span> paymenttime) rk</span><br><span class="line"><span class="keyword">from</span> prac.test6</span><br><span class="line"><span class="keyword">where</span> paymenttime&gt;=<span class="string">'2017-10-01'</span> <span class="keyword">and</span> paymenttime&lt;=<span class="string">'2017-10-31'</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    userid,</span><br><span class="line">    money</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">where</span> rk=<span class="number">1</span>;</span><br></pre></td></tr></table></figure><p></p><h2 id="第七题"><a href="#第七题" class="headerlink" title="第七题"></a>第七题</h2><p>需求：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">现有图书管理数据库的三个数据模型如下：</span><br><span class="line">图书（数据表名：BOOK）</span><br><span class="line">    序号      字段名称    字段描述    字段类型</span><br><span class="line">    1       BOOK_ID     总编号         文本</span><br><span class="line">    2       SORT        分类号         文本</span><br><span class="line">    3       BOOK_NAME   书名          文本</span><br><span class="line">    4       WRITER      作者          文本</span><br><span class="line">    5       OUTPUT      出版单位    文本</span><br><span class="line">    6       PRICE       单价          数值（保留小数点后2位）</span><br><span class="line">读者（数据表名：READER）</span><br><span class="line">    序号      字段名称    字段描述    字段类型</span><br><span class="line">    1       READER_ID   借书证号    文本</span><br><span class="line">    2       COMPANY     单位          文本</span><br><span class="line">    3       NAME        姓名          文本</span><br><span class="line">    4       SEX         性别          文本</span><br><span class="line">    5       GRADE       职称          文本</span><br><span class="line">    6       ADDR        地址          文本</span><br><span class="line">借阅记录（数据表名：BORROW LOG）</span><br><span class="line">    序号      字段名称        字段描述    字段类型</span><br><span class="line">    1       READER_ID       借书证号    文本</span><br><span class="line">    2       BOOK_ID         总编号         文本</span><br><span class="line">    3       BORROW_DATE     借书日期    日期</span><br><span class="line">（1）创建图书管理库的图书、读者和借阅三个基本表的表结构。请写出建表语句。</span><br><span class="line">（2）找出姓李的读者姓名（NAME）和所在单位（COMPANY）。</span><br><span class="line">（3）查找“高等教育出版社”的所有图书名称（BOOK_NAME）及单价（PRICE），结果按单价降序排序。</span><br><span class="line">（4）查找价格介于10元和20元之间的图书种类(SORT）出版单位（OUTPUT）和单价（PRICE），结果按出版单位（OUTPUT）和单价（PRICE）升序排序。</span><br><span class="line">（5）查找所有借了书的读者的姓名（NAME）及所在单位（COMPANY）。</span><br><span class="line">（6）求”科学出版社”图书的最高单价、最低单价、平均单价。</span><br><span class="line">（7）找出当前至少借阅了2本图书（大于等于2本）的读者姓名及其所在单位。</span><br><span class="line">（8）考虑到数据安全的需要，需定时将“借阅记录”中数据进行备份，请使用一条SQL语句，在备份用户bak下创建与“借阅记录”表结构完全一致的数据表BORROW_LOG_BAK.井且将“借阅记录”中现有数据全部复制到BORROW_L0G_ BAK中。</span><br><span class="line">（9）现在需要将原Oracle数据库中数据迁移至Hive仓库，请写出“图书”在Hive中的建表语句（Hive实现，提示：列分隔符|；数据表数据需要外部导入：分区分别以month＿part、day＿part 命名）</span><br><span class="line">（10）Hive中有表A，现在需要将表A的月分区　201505　中　user＿id为20000的user＿dinner字段更新为bonc8920，其他用户user＿dinner字段数据不变，请列出更新的方法步骤。（Hive实现，提示：Hlive中无update语法，请通过其他办法进行数据更新）</span><br></pre></td></tr></table></figure><p></p><p>(1)数据准备：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.book(book_id <span class="keyword">string</span>,</span><br><span class="line">                           <span class="string">`SORT`</span> <span class="keyword">string</span>,</span><br><span class="line">                           book_name <span class="keyword">string</span>,</span><br><span class="line">                           writer <span class="keyword">string</span>,</span><br><span class="line">                           <span class="keyword">OUTPUT</span> <span class="keyword">string</span>,</span><br><span class="line">                           price <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>));</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">'001'</span>,<span class="string">'TP391'</span>,<span class="string">'信息处理'</span>,<span class="string">'author1'</span>,<span class="string">'机械工业出版社'</span>,<span class="string">'20'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">'002'</span>,<span class="string">'TP392'</span>,<span class="string">'数据库'</span>,<span class="string">'author12'</span>,<span class="string">'科学出版社'</span>,<span class="string">'15'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">'003'</span>,<span class="string">'TP393'</span>,<span class="string">'计算机网络'</span>,<span class="string">'author3'</span>,<span class="string">'机械工业出版社'</span>,<span class="string">'29'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">'004'</span>,<span class="string">'TP399'</span>,<span class="string">'微机原理'</span>,<span class="string">'author4'</span>,<span class="string">'科学出版社'</span>,<span class="string">'39'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">'005'</span>,<span class="string">'C931'</span>,<span class="string">'管理信息系统'</span>,<span class="string">'author5'</span>,<span class="string">'机械工业出版社'</span>,<span class="string">'40'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.book <span class="keyword">VALUES</span> (<span class="string">'006'</span>,<span class="string">'C932'</span>,<span class="string">'运筹学'</span>,<span class="string">'author6'</span>,<span class="string">'科学出版社'</span>,<span class="string">'55'</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建读者表reader</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.reader (reader_id <span class="keyword">string</span>,</span><br><span class="line">                              company <span class="keyword">string</span>,</span><br><span class="line">                              <span class="keyword">name</span> <span class="keyword">string</span>,</span><br><span class="line">                              sex <span class="keyword">string</span>,</span><br><span class="line">                              grade <span class="keyword">string</span>,</span><br><span class="line">                              addr <span class="keyword">string</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">'0001'</span>,<span class="string">'阿里巴巴'</span>,<span class="string">'jack'</span>,<span class="string">'男'</span>,<span class="string">'vp'</span>,<span class="string">'addr1'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">'0002'</span>,<span class="string">'百度'</span>,<span class="string">'robin'</span>,<span class="string">'男'</span>,<span class="string">'vp'</span>,<span class="string">'addr2'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">'0003'</span>,<span class="string">'腾讯'</span>,<span class="string">'tony'</span>,<span class="string">'男'</span>,<span class="string">'vp'</span>,<span class="string">'addr3'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">'0004'</span>,<span class="string">'京东'</span>,<span class="string">'jasper'</span>,<span class="string">'男'</span>,<span class="string">'cfo'</span>,<span class="string">'addr4'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">'0005'</span>,<span class="string">'网易'</span>,<span class="string">'zhangsan'</span>,<span class="string">'女'</span>,<span class="string">'ceo'</span>,<span class="string">'addr5'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.reader <span class="keyword">VALUES</span> (<span class="string">'0006'</span>,<span class="string">'搜狐'</span>,<span class="string">'lisi'</span>,<span class="string">'女'</span>,<span class="string">'ceo'</span>,<span class="string">'addr6'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">-- 创建借阅记录表borrow_log</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.borrow_log(reader_id <span class="keyword">string</span>,</span><br><span class="line">                                 book_id <span class="keyword">string</span>,</span><br><span class="line">                                 borrow_date <span class="keyword">string</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">'0001'</span>,<span class="string">'002'</span>,<span class="string">'2019-10-14'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">'0002'</span>,<span class="string">'001'</span>,<span class="string">'2019-10-13'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">'0003'</span>,<span class="string">'005'</span>,<span class="string">'2019-09-14'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">'0004'</span>,<span class="string">'006'</span>,<span class="string">'2019-08-15'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">'0005'</span>,<span class="string">'003'</span>,<span class="string">'2019-10-10'</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.borrow_log <span class="keyword">VALUES</span> (<span class="string">'0006'</span>,<span class="string">'004'</span>,<span class="string">'2019-17-13'</span>);</span><br></pre></td></tr></table></figure><p></p><p>(2)找出姓李的读者姓名（NAME）和所在单位（COMPANY）<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">name</span>,</span><br><span class="line">    company</span><br><span class="line"><span class="keyword">from</span> prac.reader</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">name</span> <span class="keyword">like</span> <span class="string">'li%'</span>;</span><br></pre></td></tr></table></figure><p></p><p>(3)查找“高等教育出版社”的所有图书名称（BOOK_NAME）及单价（PRICE），结果按单价降序排序。<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    book_name,</span><br><span class="line">    price</span><br><span class="line"><span class="keyword">from</span> prac.book</span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> price <span class="keyword">desc</span>;</span><br></pre></td></tr></table></figure><p></p><p>(4)查找价格介于10元和20元之间的图书种类(SORT）出版单位（OUTPUT）和单价（PRICE），结果按出版单位（OUTPUT）和单价（PRICE）升序排序。<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">sort</span>,</span><br><span class="line">    <span class="keyword">output</span>,</span><br><span class="line">    price</span><br><span class="line"><span class="keyword">from</span> prac.book</span><br><span class="line"><span class="keyword">where</span> price&gt;=<span class="number">10</span> <span class="keyword">and</span> price&lt;=<span class="number">20</span></span><br><span class="line"><span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">output</span>,price;</span><br></pre></td></tr></table></figure><p></p><p>(5)查找所有借了书的读者的姓名（NAME）及所在单位（COMPANY）。<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    b.name,</span><br><span class="line">    b.company</span><br><span class="line"><span class="keyword">from</span> borrow_log <span class="keyword">as</span> a</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> reader <span class="keyword">as</span> b</span><br><span class="line">       <span class="keyword">on</span> a.reader_id=b.reader_id</span><br></pre></td></tr></table></figure><p></p><p>(6)求科学出版社图书的最高单价、最低单价、平均单价。<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    <span class="keyword">max</span>(price),</span><br><span class="line">    <span class="keyword">min</span>(price),</span><br><span class="line">    <span class="keyword">avg</span>(price)</span><br><span class="line"><span class="keyword">from</span> prac.book</span><br><span class="line"><span class="keyword">where</span> <span class="keyword">output</span>=<span class="string">'科学出版社'</span>;</span><br></pre></td></tr></table></figure><p></p><p>(7)找出当前至少借阅了2本图书（大于等于2本）的读者姓名及其所在单位<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        reader_id,</span><br><span class="line">        <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt</span><br><span class="line">    <span class="keyword">from</span> borrow_log</span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> reader_id</span><br><span class="line">    <span class="keyword">having</span> cnt&gt;=<span class="number">2</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    t2.name,</span><br><span class="line">    t2.company</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">left</span> <span class="keyword">join</span> reader <span class="keyword">as</span> t2</span><br><span class="line"><span class="keyword">on</span> t1.reader_id=t2.reader_id;</span><br></pre></td></tr></table></figure><p></p><p>(8)考虑到数据安全的需要，需定时将“借阅记录”中数据进行备份，请使用一条SQL语句，<br>在备份用户bak下创建与“借阅记录”表结构完全一致的数据表BORROW<em>LOG_BAK.井且将“借阅记录”中现有数据全部复制到BORROW_L0G</em> BAK中。</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.borrow_log_bak <span class="keyword">AS</span></span><br><span class="line">    <span class="keyword">SELECT</span> *</span><br><span class="line">    <span class="keyword">FROM</span> prac.borrow_log;</span><br></pre></td></tr></table></figure><p>(9)现在需要将原Oracle数据库中数据迁移至Hive仓库，请写出“图书”在Hive中的建表语句（Hive实现，提示：列分隔符|；数据表数据需要外部导入：分区分别以month＿part、day＿part 命名）<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">if</span> <span class="keyword">exists</span> book2;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">external</span> <span class="keyword">table</span> book2(</span><br><span class="line"> BOOK_ID     <span class="keyword">STRING</span>    <span class="keyword">COMMENT</span>    <span class="string">'总编号'</span></span><br><span class="line">,<span class="keyword">SORT</span>        <span class="keyword">STRING</span>    <span class="keyword">COMMENT</span>    <span class="string">'分类号'</span></span><br><span class="line">,BOOK_NAME   <span class="keyword">STRING</span>    <span class="keyword">COMMENT</span>    <span class="string">'书名'</span></span><br><span class="line">,WRITER      <span class="keyword">STRING</span>    <span class="keyword">COMMENT</span>    <span class="string">'作者'</span></span><br><span class="line">,<span class="keyword">OUTPUT</span>      <span class="keyword">STRING</span>    <span class="keyword">COMMENT</span>    <span class="string">'出版单位'</span></span><br><span class="line">,PRICE       <span class="keyword">STRING</span>    <span class="keyword">COMMENT</span>    <span class="string">'单价'</span></span><br><span class="line">)<span class="keyword">COMMENT</span> <span class="string">'图书表'</span></span><br><span class="line">partitioned <span class="keyword">by</span>(month_part <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'月分区'</span>,day_part <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'日分区'</span>)</span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'|'</span> <span class="keyword">stored</span> <span class="keyword">as</span> textfile;</span><br></pre></td></tr></table></figure><p></p><p>(10)Hive中有表A，现在需要将表A的月分区 201505 中 user_id为20000的user_dinner字段更新为bonc8920，其他用户user_dinner字段数据不变，请列出更新的方法步骤。</p><ul><li>1.新建临时表写入更改过的数据</li><li>2.把临时表数据写回原分区</li></ul><h2 id="第八题"><a href="#第八题" class="headerlink" title="第八题"></a>第八题</h2><p>需求：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">有一个线上服务器访问日志格式如下（用sql答题）</span><br><span class="line">时间                    接口                         ip地址</span><br><span class="line">2016-11-09 14:22:05        /api/user/login             110.23.5.33</span><br><span class="line">2016-11-09 14:23:10        /api/user/detail            57.3.2.16</span><br><span class="line">2016-11-09 15:59:40        /api/user/login             200.6.5.166</span><br><span class="line">… …</span><br><span class="line">求11月9号下午14点（14-15点），访问/api/user/login接口的top10的ip地址</span><br></pre></td></tr></table></figure><p></p><p>数据准备：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test8(<span class="string">`date`</span> <span class="keyword">string</span>,</span><br><span class="line">                <span class="keyword">interface</span> <span class="keyword">string</span>,</span><br><span class="line">                ip <span class="keyword">string</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test8 <span class="keyword">VALUES</span> </span><br><span class="line"> (<span class="string">'2016-11-09 11:22:05'</span>,<span class="string">'/api/user/login'</span>,<span class="string">'110.23.5.23'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 11:23:10'</span>,<span class="string">'/api/user/detail'</span>,<span class="string">'57.3.2.16'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 23:59:40'</span>,<span class="string">'/api/user/login'</span>,<span class="string">'200.6.5.166'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 11:14:23'</span>,<span class="string">'/api/user/login'</span>,<span class="string">'136.79.47.70'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 11:15:23'</span>,<span class="string">'/api/user/detail'</span>,<span class="string">'94.144.143.141'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 11:16:23'</span>,<span class="string">'/api/user/login'</span>,<span class="string">'197.161.8.206'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 12:14:23'</span>,<span class="string">'/api/user/detail'</span>,<span class="string">'240.227.107.145'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 13:14:23'</span>,<span class="string">'/api/user/login'</span>,<span class="string">'79.130.122.205'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 14:14:23'</span>,<span class="string">'/api/user/detail'</span>,<span class="string">'65.228.251.189'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 14:15:23'</span>,<span class="string">'/api/user/detail'</span>,<span class="string">'245.23.122.44'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 14:17:23'</span>,<span class="string">'/api/user/detail'</span>,<span class="string">'22.74.142.137'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 14:19:23'</span>,<span class="string">'/api/user/detail'</span>,<span class="string">'54.93.212.87'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 14:20:23'</span>,<span class="string">'/api/user/detail'</span>,<span class="string">'218.15.167.248'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 14:24:23'</span>,<span class="string">'/api/user/detail'</span>,<span class="string">'20.117.19.75'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 15:14:23'</span>,<span class="string">'/api/user/login'</span>,<span class="string">'183.162.66.97'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 16:14:23'</span>,<span class="string">'/api/user/login'</span>,<span class="string">'108.181.245.147'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 14:17:23'</span>,<span class="string">'/api/user/login'</span>,<span class="string">'22.74.142.137'</span>)</span><br><span class="line">,(<span class="string">'2016-11-09 14:19:23'</span>,<span class="string">'/api/user/login'</span>,<span class="string">'22.74.142.137'</span>);</span><br></pre></td></tr></table></figure><p></p><p>查询SQL<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        <span class="keyword">date_format</span>(<span class="string">`date`</span>,<span class="string">'YYYY-MM-dd HH'</span>) <span class="keyword">as</span> dt,</span><br><span class="line">        ip,</span><br><span class="line">        <span class="keyword">count</span>(<span class="number">1</span>) <span class="keyword">as</span> cnt</span><br><span class="line">    <span class="keyword">from</span> test8</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">date_format</span>(<span class="string">`date`</span>,<span class="string">'YYYY-MM-dd HH'</span>)=<span class="string">'2016-11-09 14'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span> <span class="keyword">date_format</span>(<span class="string">`date`</span>,<span class="string">'YYYY-MM-dd HH'</span>),ip</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    dt,</span><br><span class="line">    ip,</span><br><span class="line">    rk</span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        dt,</span><br><span class="line">        ip,</span><br><span class="line">        <span class="keyword">rank</span>() <span class="keyword">over</span>(<span class="keyword">order</span> <span class="keyword">by</span> cnt <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span> t1</span><br><span class="line">) <span class="keyword">as</span> t2</span><br><span class="line"><span class="keyword">where</span> rk&lt;=<span class="number">10</span>;</span><br></pre></td></tr></table></figure><p></p><h2 id="第九题"><a href="#第九题" class="headerlink" title="第九题"></a>第九题</h2><p>需求：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">有一个充值日志表credit_log，字段如下：</span><br><span class="line">`dist_id` int  &apos;区组id&apos;,</span><br><span class="line">`account` string  &apos;账号&apos;,</span><br><span class="line">`money` int   &apos;充值金额&apos;,</span><br><span class="line">`create_time` string  &apos;订单时间&apos;</span><br><span class="line"></span><br><span class="line">请写出SQL语句，查询充值日志表2019年01月02号每个区组下充值额最大的账号，要求结果：</span><br><span class="line">区组id，账号，金额，充值时间</span><br></pre></td></tr></table></figure><p></p><p>数据准备：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test9(</span><br><span class="line">            dist_id <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'区组id'</span>,</span><br><span class="line">            <span class="keyword">account</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'账号'</span>,</span><br><span class="line">           <span class="string">`money`</span> <span class="built_in">decimal</span>(<span class="number">10</span>,<span class="number">2</span>) <span class="keyword">COMMENT</span> <span class="string">'充值金额'</span>,</span><br><span class="line">            create_time <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'订单时间'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test9 <span class="keyword">VALUES</span> </span><br><span class="line"> (<span class="string">'1'</span>,<span class="string">'11'</span>,<span class="number">100006</span>,<span class="string">'2019-01-02 13:00:01'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'22'</span>,<span class="number">110000</span>,<span class="string">'2019-01-02 13:00:02'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'33'</span>,<span class="number">102000</span>,<span class="string">'2019-01-02 13:00:03'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'44'</span>,<span class="number">100300</span>,<span class="string">'2019-01-02 13:00:04'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'55'</span>,<span class="number">100040</span>,<span class="string">'2019-01-02 13:00:05'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'66'</span>,<span class="number">100005</span>,<span class="string">'2019-01-02 13:00:06'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'77'</span>,<span class="number">180000</span>,<span class="string">'2019-01-03 13:00:07'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'88'</span>,<span class="number">106000</span>,<span class="string">'2019-01-02 13:00:08'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'99'</span>,<span class="number">100400</span>,<span class="string">'2019-01-02 13:00:09'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'12'</span>,<span class="number">100030</span>,<span class="string">'2019-01-02 13:00:10'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'13'</span>,<span class="number">100003</span>,<span class="string">'2019-01-02 13:00:20'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'14'</span>,<span class="number">100020</span>,<span class="string">'2019-01-02 13:00:30'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'15'</span>,<span class="number">100500</span>,<span class="string">'2019-01-02 13:00:40'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'16'</span>,<span class="number">106000</span>,<span class="string">'2019-01-02 13:00:50'</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'17'</span>,<span class="number">100800</span>,<span class="string">'2019-01-02 13:00:59'</span>)</span><br><span class="line">,(<span class="string">'2'</span>,<span class="string">'18'</span>,<span class="number">100800</span>,<span class="string">'2019-01-02 13:00:11'</span>)</span><br><span class="line">,(<span class="string">'2'</span>,<span class="string">'19'</span>,<span class="number">100030</span>,<span class="string">'2019-01-02 13:00:12'</span>)</span><br><span class="line">,(<span class="string">'2'</span>,<span class="string">'10'</span>,<span class="number">100000</span>,<span class="string">'2019-01-02 13:00:13'</span>)</span><br><span class="line">,(<span class="string">'2'</span>,<span class="string">'45'</span>,<span class="number">100010</span>,<span class="string">'2019-01-02 13:00:14'</span>)</span><br><span class="line">,(<span class="string">'2'</span>,<span class="string">'78'</span>,<span class="number">100070</span>,<span class="string">'2019-01-02 13:00:15'</span>);</span><br></pre></td></tr></table></figure><p></p><p>查询SQL：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        dist_id,</span><br><span class="line">        <span class="keyword">account</span>,</span><br><span class="line">        <span class="keyword">sum</span>(money) <span class="keyword">as</span> sum_m</span><br><span class="line">    <span class="keyword">from</span> prac.test9</span><br><span class="line">    <span class="keyword">where</span> <span class="keyword">date_format</span>(create_time,<span class="string">'yyyy-MM-dd'</span>)=<span class="string">'2019-01-02'</span></span><br><span class="line">    <span class="keyword">group</span> <span class="keyword">by</span></span><br><span class="line">        dist_id,</span><br><span class="line">        <span class="keyword">account</span></span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    t2.dist_id,</span><br><span class="line">    t2.account,</span><br><span class="line">    t2.sum_m,</span><br><span class="line">    <span class="string">'2019-01-02'</span></span><br><span class="line"><span class="keyword">from</span>(</span><br><span class="line">        <span class="keyword">select</span></span><br><span class="line">            t1.dist_id,</span><br><span class="line">            t1.account,</span><br><span class="line">            t1.sum_m,</span><br><span class="line">            <span class="keyword">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> t1.dist_id <span class="keyword">order</span> <span class="keyword">by</span> sum_m <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line">        <span class="keyword">from</span> t1</span><br><span class="line">    ) <span class="keyword">as</span> t2</span><br><span class="line"><span class="keyword">where</span> rk=<span class="number">1</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> prac.test10(</span><br><span class="line">    <span class="string">`dist_id`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'区组id'</span>,</span><br><span class="line">    <span class="string">`account`</span> <span class="keyword">string</span> <span class="keyword">COMMENT</span> <span class="string">'账号'</span>,</span><br><span class="line">    <span class="string">`gold`</span> <span class="built_in">int</span> <span class="keyword">COMMENT</span> <span class="string">'金币'</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="第十题："><a href="#第十题：" class="headerlink" title="第十题："></a>第十题：</h2><p>需求：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">有一个账号表如下，请写出SQL语句，查询各自区组的money排名前十的账号（分组取前10）</span><br><span class="line">dist_id string  &apos;区组id&apos;,</span><br><span class="line">account string  &apos;账号&apos;,</span><br><span class="line">gold     int    &apos;金币&apos;</span><br></pre></td></tr></table></figure><p></p><p>数据准备：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="keyword">TABLE</span> prac.test10 <span class="keyword">VALUES</span> </span><br><span class="line"> (<span class="string">'1'</span>,<span class="string">'77'</span>,<span class="number">18</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'88'</span>,<span class="number">106</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'99'</span>,<span class="number">10</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'12'</span>,<span class="number">13</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'13'</span>,<span class="number">14</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'14'</span>,<span class="number">25</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'15'</span>,<span class="number">36</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'16'</span>,<span class="number">12</span>)</span><br><span class="line">,(<span class="string">'1'</span>,<span class="string">'17'</span>,<span class="number">158</span>)</span><br><span class="line">,(<span class="string">'2'</span>,<span class="string">'18'</span>,<span class="number">12</span>)</span><br><span class="line">,(<span class="string">'2'</span>,<span class="string">'19'</span>,<span class="number">44</span>)</span><br><span class="line">,(<span class="string">'2'</span>,<span class="string">'10'</span>,<span class="number">66</span>)</span><br><span class="line">,(<span class="string">'2'</span>,<span class="string">'45'</span>,<span class="number">80</span>)</span><br><span class="line">,(<span class="string">'2'</span>,<span class="string">'78'</span>,<span class="number">98</span>);</span><br><span class="line"><span class="keyword">select</span> * <span class="keyword">from</span> test10;</span><br></pre></td></tr></table></figure><p></p><p>查询SQL:<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- 查询各自区组的money排名前十的账号（分组取前10）</span></span><br><span class="line"><span class="keyword">with</span> t1 <span class="keyword">as</span>(</span><br><span class="line">    <span class="keyword">select</span></span><br><span class="line">        dist_id,</span><br><span class="line">        <span class="keyword">account</span>,</span><br><span class="line">        gold,</span><br><span class="line">        <span class="keyword">rank</span>() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> dist_id <span class="keyword">order</span> <span class="keyword">by</span> gold <span class="keyword">desc</span>) <span class="keyword">as</span> rk</span><br><span class="line">    <span class="keyword">from</span> prac.test10</span><br><span class="line">)</span><br><span class="line"><span class="keyword">select</span></span><br><span class="line">    t1.dist_id,</span><br><span class="line">    t1.account,</span><br><span class="line">    t1.gold,</span><br><span class="line">    t1.rk</span><br><span class="line"><span class="keyword">from</span> t1</span><br><span class="line"><span class="keyword">where</span> rk&lt;=<span class="number">10</span>;</span><br></pre></td></tr></table></figure><p></p><p>这10道题并不难，和工作中的HiveSQL相比真的不算什么了，日拱一卒。加油！</p></div><div class="post-copyright"><p class="copyright-item"><span>原文作者: </span><a href="https://mapan.tech/cn">MaPan</a></p><p class="copyright-item"><span>原文链接: </span><a href="https://mapan.tech/cn/f9fb.html">https://mapan.tech/cn/f9fb.html</a></p><p class="copyright-item"><span>许可协议: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a></p></div><footer class="post-footer"><nav class="post-nav"><a class="prev" href="/cn/2c3f.html"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">PostgreSql学习</span> <span class="prev-text nav-mobile">上一篇</span> </a><a class="next" href="/cn/5acd.html"><span class="next-text nav-default">一道有意思的SQL</span> <span class="prev-text nav-mobile">下一篇</span> <i class="iconfont icon-right"></i></a></nav></footer></article></div><div class="comments" id="comments"><div id="vcomments"></div></div></div></main><footer id="footer" class="footer"><div class="social-links"><a href="/cn/atom.xml" class="iconfont icon-rss" title="rss" target="_blank"></a></div><div class="copyright"><span class="division">&nbsp;</span><span class="post-count"> 全站字数 89.7k </span><span class="copyright-year">Since 2015 <span class="heart"><i class="iconfont icon-heart"></i> </span><span class="author">MaPan</span></span></div></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script src="./lib/valine/av-min.js?v=3.0.4"></script><script src="./lib/valine/Valine.min.js"></script><script type="text/javascript">new Valine({el:"#vcomments",notify:!1,verify:!0,app_id:"XtxvAXPwOzM9noIc3eyxi3AS-gzGzoHsz",app_key:"yEVQszyxb4bwLuAGU5VHnPR8",placeholder:"说点什么吧...",avatar:"mm",visitor:"ture"})</script><script type="text/javascript" src="/cn/lib/jquery/jquery.min.js"></script><script type="text/javascript" src="/cn/lib/slideout/slideout.js"></script><script type="text/javascript" src="/cn/js/src/even.js?v=2.11.0"></script></body></html>