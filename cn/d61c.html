<!DOCTYPE html><html lang="zh-Hans"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="theme-color" content="#f8f5ec"><meta name="msapplication-navbutton-color" content="#f8f5ec"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec"><meta name="referrer" content="same-origin"><meta name="referrer" content="no-referrer"><meta name="description" content="SQL的两道练习"><meta name="keywords" content="大数据,BigData,数据开发,Hadoop,Spark,Flink,Hive,HBase"><link rel="alternate" href="/cn/atom.xml" title="马攀的技术栈"><link rel="shortcut icon" type="image/x-icon" href="/cn/favicon.ico?v=2.11.0"><link rel="canonical" href="https://mapan.tech/cn/d61c.html"><link rel="stylesheet" type="text/css" href="/cn/css/style.css?v=2.11.0"><script>window.config={toc:!0,fancybox:!1,pjax:!1,latex:!1}</script><title>SQL的两道练习 - 马攀的技术栈</title></head><body><div id="mobile-navbar" class="mobile-navbar"><div class="mobile-header-logo"><a href="/cn/." class="logo">马攀的技术栈</a></div><div class="mobile-navbar-icon"><span></span> <span></span> <span></span></div></div><nav id="mobile-menu" class="mobile-menu slideout-menu"><ul class="mobile-menu-list"><a href="/cn/"><li class="mobile-menu-item">首页</li></a><a href="/cn/categories.html"><li class="mobile-menu-item">分类</li></a><a href="/cn/about.html"><li class="mobile-menu-item">关于</li></a><a href="/cn/message.html"><li class="mobile-menu-item">留言</li></a><a href="/cn/links.html"><li class="mobile-menu-item">友链</li></a></ul></nav><div class="container" id="mobile-panel"><header id="header" class="header"><div class="logo-wrapper"><a href="https://mapan.tech" class="logo">马攀的技术栈</a></div><nav class="site-navbar"><ul id="menu" class="menu"><li class="menu-item"><a class="menu-item-link" href="/cn/">首页</a></li><li class="menu-item"><a class="menu-item-link" href="/cn/categories.html">分类</a></li><li class="menu-item"><a class="menu-item-link" href="/cn/about.html">关于</a></li><li class="menu-item"><a class="menu-item-link" href="/cn/message.html">留言</a></li><li class="menu-item"><a class="menu-item-link" href="/cn/links.html">友链</a></li></ul></nav></header><main id="main" class="main"><div class="content-wrapper"><div id="content" class="content"><article class="post"><header class="post-header"><h1 class="post-title">SQL的两道练习</h1><div class="post-meta"><span class="post-time">2017-07-05 </span><span class="post-category"><a href="/cn/categories/数据库/">数据库</a> </span><span id="/cn/d61c.html" class="leancloud-visitors" data-flag-title="SQL的两道练习">阅读数 <span class="leancloud-visitors-count">1000</span> </span><span class="post-count">字数统计 1.1k </span><span class="post-count">阅读时长 5</span></div></header><div class="post-toc" id="post-toc"><h2 class="post-toc-title">文章目录</h2><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#（一）统计用户浏览量"><span class="toc-text">（一）统计用户浏览量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#答："><span class="toc-text">答：</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#（二）统计网店访问量"><span class="toc-text">（二）统计网店访问量</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#答：-1"><span class="toc-text">答：</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1）"><span class="toc-text">1）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2）"><span class="toc-text">2）</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3"><span class="toc-text">3</span></a></li></ol></li></ol></li></ol></div></div><div class="post-content"><p>找了两道Hive有关的SQL练习题目，第一道是统计用户浏览量的数据。第二道是统计京东商铺浏览量的数据。</p><h1 id="（一）统计用户浏览量"><a href="#（一）统计用户浏览量" class="headerlink" title="（一）统计用户浏览量"></a>（一）统计用户浏览量</h1><p>我们有如下的用户访问数据</p><div class="table-container"><table><thead><tr><th style="text-align:center">userId</th><th style="text-align:center">visitDate</th><th style="text-align:center">visitCount</th></tr></thead><tbody><tr><td style="text-align:center">u01</td><td style="text-align:center">2017/1/21</td><td style="text-align:center">5</td></tr><tr><td style="text-align:center">u02</td><td style="text-align:center">2017/1/23</td><td style="text-align:center">6</td></tr><tr><td style="text-align:center">u03</td><td style="text-align:center">2017/1/22</td><td style="text-align:center">8</td></tr><tr><td style="text-align:center">u04</td><td style="text-align:center">2017/1/20</td><td style="text-align:center">3</td></tr><tr><td style="text-align:center">u01</td><td style="text-align:center">2017/1/23</td><td style="text-align:center">6</td></tr><tr><td style="text-align:center">u01</td><td style="text-align:center">2017/2/21</td><td style="text-align:center">8</td></tr><tr><td style="text-align:center">u02</td><td style="text-align:center">2017/1/23</td><td style="text-align:center">6</td></tr><tr><td style="text-align:center">u01</td><td style="text-align:center">2017/2/22</td><td style="text-align:center">4</td></tr></tbody></table></div><p>要求使用SQL统计出每个用户的累积访问次数，如下表所示：</p><div class="table-container"><table><thead><tr><th style="text-align:center">用户id</th><th style="text-align:center">月份</th><th style="text-align:center">小计</th><th style="text-align:center">累积</th></tr></thead><tbody><tr><td style="text-align:center">u01</td><td style="text-align:center">2017-01</td><td style="text-align:center">11</td><td style="text-align:center">11</td></tr><tr><td style="text-align:center">u01</td><td style="text-align:center">2017-02</td><td style="text-align:center">12</td><td style="text-align:center">23</td></tr><tr><td style="text-align:center">u02</td><td style="text-align:center">2017-01</td><td style="text-align:center">12</td><td style="text-align:center">12</td></tr><tr><td style="text-align:center">u03</td><td style="text-align:center">2017-01</td><td style="text-align:center">8</td><td style="text-align:center">8</td></tr><tr><td style="text-align:center">u04</td><td style="text-align:center">2017-01</td><td style="text-align:center">3</td><td style="text-align:center">3</td></tr></tbody></table></div><p><a href="./d61c/action.txt">原始数据</a>如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">u01     2017/1/21       5</span><br><span class="line">u02     2017/1/23       6</span><br><span class="line">u03     2017/1/22       8</span><br><span class="line">u04     2017/1/20       3</span><br><span class="line">u01     2017/1/23       6</span><br><span class="line">u01     2017/2/21       8</span><br><span class="line">u02     2017/1/23       6</span><br><span class="line">u01     2017/2/22       4</span><br></pre></td></tr></table></figure><p></p><p>建表语句<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">action</span></span><br><span class="line">(userId <span class="keyword">string</span>,</span><br><span class="line">visitDate <span class="keyword">string</span>,</span><br><span class="line">visitCount <span class="built_in">int</span>) </span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">"\t"</span>;</span><br></pre></td></tr></table></figure><p></p><h2 id="答："><a href="#答：" class="headerlink" title="答："></a>答：</h2><p>一、首先转换月份格式，统计每个月、每个用户的访问量<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    userid <span class="keyword">id</span> , </span><br><span class="line">    <span class="keyword">date_format</span>(REGEXP_REPLACE(visitdate,<span class="string">'/'</span>,<span class="string">'-'</span>),<span class="string">'yyyy-MM'</span>) mon , </span><br><span class="line">    <span class="keyword">sum</span>(visitcount) views</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    <span class="keyword">action</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">    userid , visitdate;</span><br></pre></td></tr></table></figure><p></p><p>执行结果:<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">id	mon	views</span><br><span class="line">u01	2017-01	5</span><br><span class="line">u01	2017-01	6</span><br><span class="line">u01	2017-02	8</span><br><span class="line">u01	2017-02	4</span><br><span class="line">u02	2017-01	12</span><br><span class="line">u03	2017-01	8</span><br><span class="line">u04	2017-01	3</span><br></pre></td></tr></table></figure><p></p><p>二、再按照月份和用户进行分组并统计访问量。<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    <span class="keyword">id</span> , </span><br><span class="line">    mon , </span><br><span class="line">    <span class="keyword">sum</span>(visitcount) views</span><br><span class="line"><span class="keyword">FROM</span>(<span class="keyword">SELECT</span> </span><br><span class="line">    userid <span class="keyword">id</span> , </span><br><span class="line">    <span class="keyword">date_format</span>(REGEXP_REPLACE(visitdate,<span class="string">'/'</span>,<span class="string">'-'</span>),<span class="string">'yyyy-MM'</span>) mon , </span><br><span class="line">    visitcount</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    <span class="keyword">action</span>) t1</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> <span class="keyword">id</span> ,mon;</span><br></pre></td></tr></table></figure><p></p><p>执行结果<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">id	mon	views</span><br><span class="line">u01	2017-01	11</span><br><span class="line">u01	2017-02	12</span><br><span class="line">u02	2017-01	12</span><br><span class="line">u03	2017-01	8</span><br><span class="line">u04	2017-01	3</span><br></pre></td></tr></table></figure><p></p><p>三、 对每个用户的数据进行累加，再次子查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span></span><br><span class="line">    userid,</span><br><span class="line">    mon,</span><br><span class="line">    views,</span><br><span class="line">    (<span class="keyword">sum</span>(views) <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> userid <span class="keyword">order</span> <span class="keyword">by</span> mon)) total</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> </span><br><span class="line">        userid , </span><br><span class="line">        mon , </span><br><span class="line">        <span class="keyword">sum</span>(visitcount) views</span><br><span class="line">    <span class="keyword">FROM</span>(<span class="keyword">SELECT</span> </span><br><span class="line">            userid , </span><br><span class="line">            <span class="keyword">date_format</span>(REGEXP_REPLACE(visitdate,<span class="string">'/'</span>,<span class="string">'-'</span>),<span class="string">'yyyy-MM'</span>) mon , </span><br><span class="line">            visitcount</span><br><span class="line">        <span class="keyword">FROM</span> </span><br><span class="line">            <span class="keyword">action</span>) t1</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">            userid ,mon)t2;</span><br></pre></td></tr></table></figure><p>执行结果<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">userid	mon	views	total</span><br><span class="line">u01	2017-01	11	11</span><br><span class="line">u01	2017-02	12	23</span><br><span class="line">u02	2017-01	12	12</span><br><span class="line">u03	2017-01	8	8</span><br><span class="line">u04	2017-01	3	3</span><br></pre></td></tr></table></figure><p></p><hr><h1 id="（二）统计网店访问量"><a href="#（二）统计网店访问量" class="headerlink" title="（二）统计网店访问量"></a>（二）统计网店访问量</h1><p>有50W个京东店铺，每个顾客访问任何一个店铺的任何一个商品时都会产生一条访问日志，访问日志存储的表名为visit，访客的用户id为user_id，被访问的店铺名称为shop，请统计：<br><a href="./d61c/visit.txt">原始数据</a>如下：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">u1	a</span><br><span class="line">u2	b</span><br><span class="line">u1	b</span><br><span class="line">u1	a</span><br><span class="line">u3	c</span><br><span class="line">u4	b</span><br><span class="line">u1	a</span><br><span class="line">u2	c</span><br><span class="line">u5	b</span><br><span class="line">u4	b</span><br><span class="line">u6	c</span><br><span class="line">u2	c</span><br><span class="line">u1	b</span><br><span class="line">u2	a</span><br><span class="line">u2	a</span><br><span class="line">u3	a</span><br><span class="line">u5	a</span><br><span class="line">u5	a</span><br><span class="line">u5	a</span><br></pre></td></tr></table></figure><p></p><p>建表：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> visit(user_id <span class="keyword">string</span>,shop <span class="keyword">string</span>) </span><br><span class="line"><span class="keyword">row</span> <span class="keyword">format</span> <span class="keyword">delimited</span> <span class="keyword">fields</span> <span class="keyword">terminated</span> <span class="keyword">by</span> <span class="string">'\t'</span>;</span><br></pre></td></tr></table></figure><p></p><p>问：<br>1）每个店铺的UV（访客数）<br>2）每个店铺访问次数top3的访客信息。输出店铺名称、访客id、访问次数</p><h2 id="答：-1"><a href="#答：-1" class="headerlink" title="答："></a>答：</h2><h3 id="1）"><a href="#1）" class="headerlink" title="1）"></a>1）</h3><p>一、使用GROUP BY对用户进行去重<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">        shop,</span><br><span class="line">        user_id</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        visit</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">        shop,</span><br><span class="line">        user_id</span><br></pre></td></tr></table></figure><p></p><p>执行结果：<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">shop	user_id</span><br><span class="line">a	u1</span><br><span class="line">a	u2</span><br><span class="line">a	u3</span><br><span class="line">a	u5</span><br><span class="line">b	u1</span><br><span class="line">b	u2</span><br><span class="line">b	u4</span><br><span class="line">b	u5</span><br><span class="line">c	u2</span><br><span class="line">c	u3</span><br><span class="line">c	u6</span><br></pre></td></tr></table></figure><p></p><p>二、对去重的结果进行用户数目统计<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    shop,</span><br><span class="line">    <span class="keyword">COUNT</span>(*) uv</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">        shop,</span><br><span class="line">        user_id</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        visit</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">        shop,</span><br><span class="line">        user_id) t1</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    shop;</span><br></pre></td></tr></table></figure><p></p><p>执行结果<br></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shop	uv</span><br><span class="line">a	4</span><br><span class="line">b	4</span><br><span class="line">c	3</span><br></pre></td></tr></table></figure><p></p><h3 id="2）"><a href="#2）" class="headerlink" title="2）"></a>2）</h3><p>一、计算每个人访问每个店铺的总次数<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    shop,</span><br><span class="line">    user_id,</span><br><span class="line">    <span class="keyword">count</span>(*)</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    visit</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    shop,</span><br><span class="line">    user_id;</span><br></pre></td></tr></table></figure><p></p><p>二、针对同一店铺，对方问次数进行逆序排序，并计算rank值<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    shop,</span><br><span class="line">    user_id,</span><br><span class="line">    ct,</span><br><span class="line">    row_number() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> shop <span class="keyword">order</span> <span class="keyword">by</span> ct <span class="keyword">desc</span> ) rk</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> </span><br><span class="line">        shop,</span><br><span class="line">        user_id,</span><br><span class="line">        <span class="keyword">count</span>(*) ct</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        visit</span><br><span class="line">    <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">        shop,</span><br><span class="line">        user_id) t1;</span><br></pre></td></tr></table></figure><p></p><p>三、去店铺访问前三名的用户<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    shop,</span><br><span class="line">    user_id,</span><br><span class="line">    ct</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">        shop,</span><br><span class="line">        user_id,</span><br><span class="line">        ct,</span><br><span class="line">        row_number() <span class="keyword">over</span>(<span class="keyword">partition</span> <span class="keyword">by</span> shop <span class="keyword">order</span> <span class="keyword">by</span> ct <span class="keyword">desc</span> ) rk</span><br><span class="line">    <span class="keyword">FROM</span></span><br><span class="line">        (<span class="keyword">SELECT</span> </span><br><span class="line">            shop,</span><br><span class="line">            user_id,</span><br><span class="line">            <span class="keyword">count</span>(*) ct</span><br><span class="line">        <span class="keyword">FROM</span></span><br><span class="line">            visit</span><br><span class="line">        <span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">            shop,</span><br><span class="line">            user_id) t1)t2</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    rk &lt;= <span class="number">3</span>;</span><br></pre></td></tr></table></figure><p></p><h3 id="3"><a href="#3" class="headerlink" title="3"></a>3</h3><p>Exer4：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> user_age</span><br><span class="line">(dt <span class="keyword">STRING</span>, //日期</span><br><span class="line">user_id <span class="keyword">STRING</span>, //用户</span><br><span class="line">age <span class="built_in">INT</span>) //年龄</span><br></pre></td></tr></table></figure><p></p><p>1、所有用户的总数及平均年龄<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> </span><br><span class="line">    user_id,</span><br><span class="line">    <span class="keyword">AVG</span>(age) age</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    user_age</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">    user_id;t1</span><br></pre></td></tr></table></figure><p></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">COUNT</span>(*) count1,</span><br><span class="line">    <span class="keyword">AVG</span>(aage) avg_total_age</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> </span><br><span class="line">    user_id,</span><br><span class="line">    <span class="keyword">AVG</span>(age) aage</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    user_age</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">    user_id)t1;t0</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">count1  avg_total_age</span><br><span class="line">3   27.0</span><br><span class="line">~~~~~~~~~~~~~~~</span><br></pre></td></tr></table></figure><p>2、活跃用户的总数及其平均年龄(2种方法)<br>① 用lead或者tag,在用Datediff找相邻一天的，然后去重就得出结果，不具备扩展性，实现多天活跃比较复杂。<br>② 等差数列<br>2.1 给每个用户的日期,同一天去重rank<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    dt,</span><br><span class="line">    ROW_Number() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt) rk</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    user_age</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    user_id,dt;t2</span><br></pre></td></tr></table></figure><p></p><p>2.2 用等差数列<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    <span class="keyword">DATE_SUB</span>(dt,rk) diff</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    t2;t3</span><br></pre></td></tr></table></figure><p></p><p>2.3 求出差距<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    <span class="keyword">COUNT</span>(diff) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id,diff) count_diff</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    t3;t4</span><br></pre></td></tr></table></figure><p></p><p>2.4 最大连续天数<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    t4</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    count_diff &gt;= <span class="number">2</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    user_id;t5</span><br></pre></td></tr></table></figure><p></p><p>2.5 去重并且得到age<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    user_age.user_id,</span><br><span class="line">    user_age.age</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    user_age,t5</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    user_age.user_id = t5.user_id;t6</span><br><span class="line"></span><br><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">COUNT</span>(*) active_count,</span><br><span class="line">    <span class="keyword">AVG</span>(age) active_avg_age</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    t6; t7</span><br></pre></td></tr></table></figure><p></p><p>3、合并</p><p>最终SQL：<br></p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span></span><br><span class="line">    count_total,</span><br><span class="line">    avg_total_age,</span><br><span class="line">    active_count,</span><br><span class="line">    active_avg_age</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">(<span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">COUNT</span>(*) count_total,</span><br><span class="line">    <span class="keyword">AVG</span>(aage) avg_total_age</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span> </span><br><span class="line">    user_id,</span><br><span class="line">    <span class="keyword">AVG</span>(age) aage</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    user_age</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span> </span><br><span class="line">    user_id)t1)t0</span><br><span class="line">,</span><br><span class="line">(<span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">COUNT</span>(*) active_count,</span><br><span class="line">    <span class="keyword">AVG</span>(age) active_avg_age</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">(<span class="keyword">SELECT</span></span><br><span class="line">    <span class="keyword">DISTINCT</span> user_age.user_id,</span><br><span class="line">    user_age.age</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    user_age,</span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">    user_id</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    <span class="keyword">COUNT</span>(diff) <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id,diff) count_diff</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    <span class="keyword">DATE_SUB</span>(dt,rk) diff</span><br><span class="line"><span class="keyword">FROM</span></span><br><span class="line">    (<span class="keyword">SELECT</span></span><br><span class="line">    user_id,</span><br><span class="line">    dt,</span><br><span class="line">    ROW_Number() <span class="keyword">OVER</span>(<span class="keyword">PARTITION</span> <span class="keyword">BY</span> user_id <span class="keyword">ORDER</span> <span class="keyword">BY</span> dt) rk</span><br><span class="line"><span class="keyword">FROM</span> </span><br><span class="line">    user_age</span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    user_id,dt)t2)t3)t4</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    count_diff &gt;= <span class="number">2</span></span><br><span class="line"><span class="keyword">GROUP</span> <span class="keyword">BY</span></span><br><span class="line">    user_id)t5</span><br><span class="line"><span class="keyword">WHERE</span></span><br><span class="line">    user_age.user_id = t5.user_id)t6)t7;</span><br></pre></td></tr></table></figure><p></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">count_total avg_total_age   active_count    active_avg_age</span><br><span class="line">3   27.0    1   19.0</span><br><span class="line">~~~~~~~~~~~~~~~</span><br></pre></td></tr></table></figure></div><div class="post-copyright"><p class="copyright-item"><span>原文作者: </span><a href="https://mapan.tech/cn">MaPan</a></p><p class="copyright-item"><span>原文链接: </span><a href="https://mapan.tech/cn/d61c.html">https://mapan.tech/cn/d61c.html</a></p><p class="copyright-item"><span>许可协议: </span><a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a></p></div><footer class="post-footer"><nav class="post-nav"><a class="prev" href="/cn/d3cd.html"><i class="iconfont icon-left"></i> <span class="prev-text nav-default">maven加速</span> <span class="prev-text nav-mobile">上一篇</span> </a><a class="next" href="/cn/51f3.html"><span class="next-text nav-default">Hadoop序列化</span> <span class="prev-text nav-mobile">下一篇</span> <i class="iconfont icon-right"></i></a></nav></footer></article></div><div class="comments" id="comments"><div id="vcomments"></div></div></div></main><footer id="footer" class="footer"><div class="social-links"><a href="/cn/atom.xml" class="iconfont icon-rss" title="rss" target="_blank"></a></div><div class="copyright"><span class="division">&nbsp;</span><span class="post-count"> 全站字数 84.7k </span><span class="copyright-year">Since 2015 <span class="heart"><i class="iconfont icon-heart"></i> </span><span class="author">MaPan</span></span></div></footer><div class="back-to-top" id="back-to-top"><i class="iconfont icon-up"></i></div></div><script src="./lib/valine/av-min.js?v=3.0.4"></script><script src="./lib/valine/Valine.min.js"></script><script type="text/javascript">new Valine({el:"#vcomments",notify:!1,verify:!0,app_id:"XtxvAXPwOzM9noIc3eyxi3AS-gzGzoHsz",app_key:"yEVQszyxb4bwLuAGU5VHnPR8",placeholder:"说点什么吧...",avatar:"mm",visitor:"ture"})</script><script type="text/javascript" src="/cn/lib/jquery/jquery.min.js"></script><script type="text/javascript" src="/cn/lib/slideout/slideout.js"></script><script type="text/javascript" src="/cn/js/src/even.js?v=2.11.0"></script></body></html>